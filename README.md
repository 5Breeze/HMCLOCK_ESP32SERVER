# HMCLOCK授时服务端

该项目基于 ESP32，使用 NimBLE 库实现 BLE 设备扫描和连接，并通过 NTP 网络时间与蓝牙设备进行时间同步。集成了 WiFi 配网功能，使设备可在首次上电时通过热点进行网络配置。项目已经在ESP32、ESP32C3上进行测试通过，本项目不依赖任何外设资源，没有任何外围硬件要求，理论上任意esp32开发板都可编译运行。

---

## ✨ 项目特性

- 📡 **WiFi 自动连接与网页配网**
- 🕒 **NTP 网络对时**
- 📱 **通过 BLE 向指定设备同步当前时间**
- 📅 **支持农历（阴历）时间计算与发送**
- 🔁 **自动重连与设备跳过机制**
- 🌐 **Web 配网页面（AP模式）**
- 🔌 **使用 Preferences 持久化存储 WiFi 信息**

---

## 🧱 依赖库

- `NimBLE-Arduino` 
- `WiFi.h`
- `Preferences.h`
- `WebServer.h`

---

## 📲 使用流程

1. **首次启动 / 未配置 WiFi**
    - ESP32 创建一个名为 `DLG-Clock-Config` 的热点。
    - 手机/电脑连接该热点，访问 `192.168.4.1`。
    - 输入 WiFi SSID 和密码，保存后设备将自动重启并连接网络。

2. **连接 WiFi 并同步时间**
    - 成功连接网络后，从阿里 NTP 服务器获取当前 UTC+8 的北京时间。
    - 计算农历时间。
    - 扫描 BLE 设备（名称以 `DLG-CLOCK` 开头）。
    - 每个已连接过的设备 60 分钟内不会重复连接。
    - 向找到的设备写入包含阳历与农历的时间数据。

---

## 🧪 对时指令格式（12字节）

对时指令与WEBUI命令构建相同，在c下插入了一个简单的农历计算代码库
https://github.com/vincascm/cdate

| 字节 | 内容         | 说明                       |
|------|--------------|----------------------------|
| 0    | 0x91         | 指令头                     |
| 1-2  | 年份         | 小端序（低位在前）         |
| 3    | 月份         | 1-12                       |
| 4    | 日           | 1-31                       |
| 5    | 时           | 0-23                       |
| 6    | 分           | 0-59                       |
| 7    | 秒           | 0-59                       |
| 8    | 星期         | 0（周日）~6（周六）        |
| 9    | 农历年差值   | `农历年 - 2020`            |
| 10   | 农历月       | 若为闰月，值加 128         |
| 11   | 农历日       | 1-30                       |

---

## 📁 代码结构说明

| 模块            | 功能概述                                 |
|-----------------|------------------------------------------|
| `WiFi 配网`     | 配置热点、网页配网、存储 WiFi 凭据        |
| `NTP 时间同步`  | 使用阿里 NTP 服务获取北京时间             |
| `BLE 扫描连接`  | 扫描设备，连接目标设备                    |
| `对时命令构造`  | 生成带农历时间的 12 字节数据包并写入 BLE  |
| `农历算法`      | 支持 1900~2051 年的阳历转农历             |

---
